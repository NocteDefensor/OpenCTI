# Install Docker Swarm and Portainer
---

## Purpose

### Docker Swarm

- Docker swarm is a container orchestration tool. It allows you to deploy multiple containers spread out over 1 or multiple host machines. This will allow us to have high availability for the OpenCTI stack. 
- Further Reading: https://docs.docker.com/engine/swarm/key-concepts/

### Portainer
- Portainer is a graphical user interface tool that allows us to deploy docker-compose stacks to the swarm easily.
- Further Reading: https://www.portainer.io/

## Installation Instructions:

### Docker Swarm

1. Before installing docker we want to update the repositories and install any prereq's
   - Update repository
  `sudo apt-get update`
   - Install prereq's
   ```
   sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common`
    ```
   - install the GPG key
   `curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -`
   - Check fingerprint of key (should come back to docker release)
   `sudo apt-key fingerprint 0EBFCD88`
   - Add docker stable repository
   ```
   sudo add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable"
   ```
   - Install Docker and docker-compose
   ```
   sudo apt-get update
   sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose
   ```
   - Check docker version
   `sudo docker version`

   - Manage docker as non root user.  After this command is ran, it is necessary to log off and log back on. 
   `sudo usermod -aG docker $USER`

2. Create Docker Swarm. 
    - On the first node(which will be our manager) we need to run the following command to initialize the swarm.(replace <ManagerIP> with your actual private IP address.)
    ` docker swarm init --advertise-addr <MANAGER-IP>`
        - This command will output a command to the screen which you will need to run on the other nodes to join them to the swarm. Note- Only 1 host is required. If you don't have the resources for 2 or more hosts, you can still run swarm with only 1 host. You will do everything the same EXCEPT joining other machines to the swarm. That can be done later if resources are required or you wish to expand. 
    - On the second and any subsequent node, run the command that was outputted by the docker swarm init command you ran on the manager. It will look something like this:
    `docker swarm join --token <LONG-TOKEN-ID> <IP-ADDRESS-OF-MANAGER:PORT>`
        - NOTE: all nodes must be on the same subnet and must have network connectivity. 


### Portainer

1. Create directory and cd into newly created directory
`mkdir -p /opt/portainer && cd /opt/portainer`
2. Curl  Portainer docker-compose file from my repository OR from portainer
    - Portainer official docker-compose can be found here: https://downloads.portainer.io/portainer-agent-stack.yml
    `curl -L https://downloads.portainer.io/portainer-agent-stack.yml -o portainer-agent-stack.yml`
    - Note if you use the docker-compose from portainer, you will need to change the port mappings in it as it will conflict with OpenCTI port mappings. They will need to be mapped as so:
![image.png](/.attachments/image-286db768-e00f-471f-a77b-ae0b17928def.png)

    








